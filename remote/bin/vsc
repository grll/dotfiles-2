#!/usr/bin/env bash
# vsc: open VS Code (works locally and remotely, PR-aware)
set -euo pipefail

# Source config for CLUSTER variable
[[ -f "$HOME/dotfiles/config.sh" ]] && source "$HOME/dotfiles/config.sh"

dir="${1:-$(pwd)}"

if [[ -n "${SSH_CONNECTION:-}" ]]; then
    if ! kitten @ ls &>/dev/null; then
        echo "error: kitty remote control not available (use kitten ssh)" >&2
        exit 1
    fi
    # Use full path since kitty background doesn't have user's PATH
    kitten @ launch --type=background -- /opt/homebrew/bin/code --remote "ssh-remote+${CLUSTER}" "$dir"

    # Check for PR and open it after VS Code connects (in background)
    (
        pr_url=$(gh pr view --json url -q '.url' 2>/dev/null || true)
        if [[ -n "$pr_url" ]]; then
            echo "PR detected, will open after VS Code connects..."
            sleep 8  # Give VS Code time to connect to remote
            kitten @ launch --type=background -- open "vscode://github.vscode-pull-request-github/checkout-pull-request?uri=${pr_url}"
        fi
    ) &
else
    code "$dir"
    # Check for PR locally
    pr_url=$(gh pr view --json url -q '.url' 2>/dev/null || true)
    if [[ -n "$pr_url" ]]; then
        sleep 2
        open "vscode://github.vscode-pull-request-github/checkout-pull-request?uri=${pr_url}"
    fi
fi
